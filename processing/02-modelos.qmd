---
title: "Modelo de efectos aleatorios: Tesis de Magister"
format:
  html: 
    code-fold: true
    html-math-method: katex
    number-sections: true
    code-link: true
    title-block-banner: true
    theme:
      - pretty.scss
  pdf: 
    geometry: margin=2cm
    template-partials: 
      - title.tex
    keep-tex: true
    include-in-header:
      text: |
        \usepackage[noblocks]{authblk}
        \renewcommand*{\Authsep}{, }
        \renewcommand*{\Authand}{, }
        \renewcommand*{\Authands}{, }
        \renewcommand\Affilfont{\small}
    number-sections: true
editor: source
author:   
  - name: René Canales
    affiliations:
      - ref: 1
      - ref: 2     
affiliations: 
  - id: 1
    name: Instituto de Sociología, Pontificia Universidad Católica de Chile
  - id: 2
    name: Centro de estudios del conflicto y cohesión social (COES)
citeproc: true
abstract: | 
  \newline
  **Keywords**: 
link-citations: true
linestretch: 1.5       
mainfont: Times New Roman
fontlinewidth: 13pt          
colorlinks: true
fig-height: 4
fig-width: 7.5
---

```{r}
#| results: false
#| warning: false
#| message: false
#| echo: false

if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjlabelled, 
               sjmisc, 
               sjPlot,
               gt,
               xfun,
               lme4,
               here,
               tidyr,
               naniar,
               dplyr,
               broom,
               broom.mixed,
               texreg,
               kableExtra,
               emmeans)

options(scipen=999)
rm(list = ls())
```


```{r}
#| warning: false
#| message: false
#| echo: false


load(here("~/GitHub/protest_effects/input/data/proc/elsoc_final.RData"))
```

```{r}
#| warning: false
#| message: false
#| echo: false

# CORRECCIONES A LA BASE
elsoc_final <- elsoc_final %>%
  mutate(
    # Corregir años de educación
    educ_years_corr = case_when(
      educ_cat == "Media incompleta o menos" ~ 10,
      educ_cat == "Media completa" ~ 12,
      educ_cat == "Técnica superior incompleta" ~ 13,
      educ_cat == "Técnica superior completa" ~ 15,
      educ_cat == "Universitaria incompleta" ~ 15,
      educ_cat == "Universitaria completa" ~ 17,
      educ_cat == "Postgrado" ~ 19,
      TRUE ~ NA_real_
    ),
    # Recalcular movilidad con años corregidos
    movilidad_years_corr = educ_years_corr - educ_parental_max,
    # Crear matriz origen-destino
    educ_destino = case_when(
      educ_years_corr < 12 ~ "Bajo",
      educ_years_corr >= 12 & educ_years_corr < 16 ~ "Medio",
      educ_years_corr >= 16 ~ "Alto"
    ),
    educ_origen = case_when(
      educ_parental_max < 12 ~ "Bajo",
      educ_parental_max >= 12 & educ_parental_max < 16 ~ "Medio",
      educ_parental_max >= 16 ~ "Alto"
    ),
    matriz_movilidad = interaction(educ_origen, educ_destino, sep = " → ")
  )
```

## Modelos Exploratorios

```{r}
#| warning: false
#| message: false
#| echo: false
#| results: false

# Paso 1: Convertir a factor no ordenado
elsoc_final <- elsoc_final %>%
  mutate(
    educ_cat_unordered = factor(educ_cat_factor, ordered = FALSE)
  )

# Paso 2: Aplicar relevel
elsoc_final <- elsoc_final %>%
  mutate(
    educ_cat_factor_ref = relevel(educ_cat_unordered, ref = "Media completa"),
    
    # Dummies
    tecnica_completa = if_else(educ_cat == "Técnica superior completa", 1, 0),
    univ_completa = if_else(educ_cat == "Universitaria completa", 1, 0),
    educ_X_movilidad = paste(educ_cat, movilidad_cat, sep = "_")
  )

# Verificar
table(elsoc_final$educ_cat_factor_ref)
levels(elsoc_final$educ_cat_factor_ref)

```

# Modelos Descriptivos

## Modelo Nulo (Base de comparación)

```{r}
#| warning: false
#| message: false
#| echo: false 

# Modelo 0: Solo efectos aleatorios (sin predictores)
mod0_null <- glmer(
  protesta_dummy ~ 1 + (1 | idencuesta),
  data = elsoc_final,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
)

summary(mod0_null)

# Calcular ICC (Intraclass Correlation)
# ¿Cuánta varianza es between-individuals vs within?
performance::icc(mod0_null)
```
El coeficiente de correlación intraclase (ICC) del modelo nulo es 0.475, indicando que aproximadamente la mitad de la varianza en participación en protesta se debe a diferencias entre individuos, mientras que la otra mitad corresponde a variación dentro de individuos a través del tiempo. Este ICC sustancial (>0.4) justifica el uso de modelos de efectos aleatorios que ajusten por la correlación intra-individual y eviten la subestimación de errores estándar inherente a modelos pooled (Hox, 2010).

```{r}
#| warning: false
#| message: false
#| echo: false 

# Modelo Pooled: OLS sin efectos aleatorios
mod_pooled <- lm(
  protesta_dummy ~ educ_cat_factor_ref + 
    edad + edad_cuadratica + mujer + 
    ideologia_std + interes_politica +
    factor(year),
  data = elsoc_final
)

# SEs robustos por cluster
library(sandwich)
library(lmtest)

# Tabla con SEs ajustados
coeftest(mod_pooled, vcov = vcovCL(mod_pooled, cluster = ~ idencuesta))
```

## Modelos para H1 (No linealidad)

### Modelo básico de educación categórica

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 1: Solo educación (sin controles)
mod1_educ_simple <- glmer(
  protesta_dummy ~ educ_cat_factor_ref + 
    (1 | idencuesta),
  data = elsoc_final,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
)

summary(mod1_educ_simple)

```

### Modelo con controles demográficos

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 2: Educación + demográficos
mod2_educ_demo <- glmer(
  protesta_dummy ~ educ_cat_factor_ref + 
    edad + edad_cuadratica + mujer +
    (1 | idencuesta),
  data = elsoc_final,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))

summary(mod2_educ_demo)
```
### Modelo Completo H1 

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 3: Full model para H1
mod3_h1_full <- glmer(
  protesta_dummy ~ educ_cat_factor_ref + 
    edad + edad_cuadratica + mujer +
    ideologia_std + interes_politica +
    conf_instituciones + eficacia_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
)

summary(mod3_h1_full)
```

