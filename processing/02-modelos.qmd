---
title: "Modelos Exploratorios: Tesis de Magister"
format:
  html: 
    code-fold: true
    html-math-method: katex
    number-sections: true
    code-link: true
    title-block-banner: true
    theme:
      - pretty.scss
  pdf: 
    geometry: margin=2cm
    template-partials: 
      - title.tex
    keep-tex: true
    include-in-header:
      text: |
        \usepackage[noblocks]{authblk}
        \renewcommand*{\Authsep}{, }
        \renewcommand*{\Authand}{, }
        \renewcommand*{\Authands}{, }
        \renewcommand\Affilfont{\small}
    number-sections: true
editor: source
author:   
  - name: René Canales
    affiliations:
      - ref: 1
      - ref: 2     
affiliations: 
  - id: 1
    name: Instituto de Sociología, Pontificia Universidad Católica de Chile
  - id: 2
    name: Centro de estudios del conflicto y cohesión social (COES)
citeproc: true
abstract: | 
  \newline
  **Keywords**: 
link-citations: true
linestretch: 1.5       
mainfont: Times New Roman
fontlinewidth: 13pt          
colorlinks: true
fig-height: 4
fig-width: 7.5
---

```{r}
#| results: false
#| warning: false
#| message: false
#| echo: false

if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjlabelled, 
               sjmisc, 
               sjPlot,
               gt,
               xfun,
               lme4,
               glmmTMB,
               sjstats,
               here,
               tidyr,
               naniar,
               dplyr,
               broom,
               broom.mixed,
               texreg,
               kableExtra,
               emmeans,
               ggeffects,
               performance)

options(scipen=999)
rm(list = ls())
```


```{r}
#| warning: false
#| message: false
#| echo: false


load(here("~/GitHub/protest_effects/input/data/proc/elsoc_final.RData"))
```


# Modelos Exploratorios

```{r}
#| warning: false
#| message: false
#| echo: false
#| results: false


# Paso 1: Convertir a factor no ordenado
elsoc_final_2 <- elsoc_final_2 %>%
  mutate(
    educ_cat_unordered = factor(educ_cat_factor, ordered = FALSE)
  )

```

La educación se convierte en factor ordenado dada la naturaleza jerárquica de la educación. Pues, la educación tiene una secuencia lógica donde cada nivel representa un mayor grado de formación académica. Es decir, constituye una variable ordinal donde el orden importa: Media < Técnica < Universitaria.

Lo anterior permite modelar efectos no lineales. Al ser factor ordenado, se puede capturar el gradiente educativo donde cada nivel superior tiene mayor efecto, se puede detectar patrones no monotónicos y realizar contrastes específicos entre niveles adyacentes.

## Educación y Curva Temporal de Participación

Esta sección examina en qué medida el nivel educativo se relaciona con la **curva temporal** de participación en protestas. A diferencia de los modelos anteriores que tratan el tiempo como variable de control, estos modelos tipo "growth curve" analizan cómo las trayectorias de participación política varían según nivel educativo.

### Preparación de datos: Educación en t1

Para estos modelos, utilizamos el nivel educativo máximo alcanzado medido en la primera ola de cada individuo, asegurando que la educación sea un predictor baseline que no varía con el tiempo.

```{r}
#| warning: false
#| message: false
#| echo: false

# Crear educación baseline (primera medición por individuo)
elsoc_final_2 <- elsoc_final_2 %>%
  group_by(idencuesta) %>%
  arrange(idencuesta, ola) %>%
  mutate(
    # Educación continua en t1
    educ_years_t1 = first(na.omit(educ_years)),
    
    # Educación categórica en t1
    educ_cat_t1 = first(na.omit(as.character(educ_cat_factor)))
  ) %>%
  ungroup() %>%
  mutate(
    # Convertir a factor con mismos niveles
    educ_cat_t1 = factor(educ_cat_t1, 
                         levels = levels(educ_cat_factor))
  )

# Verificar
elsoc_final_2 %>%
  select(idencuesta, ola, educ_years, educ_years_t1, educ_cat_factor, educ_cat_t1) %>%
  head(20) %>%
  kable() %>%
  kable_styling()
```

La tabla muestra que `educ_years_t1` y `educ_cat_t1` capturan el nivel educativo de cada individuo en su primera medición, manteniéndose constante a través de las olas. Esto permite interpretar los modelos como efectos de la educación **baseline** sobre las trayectorias temporales de participación.

### Modelo M1: Nulo (solo efectos aleatorios)

```{r}
#| warning: false
#| message: false
#| echo: false

# M1: Modelo nulo (sin predictores)
m1_growth_null <- glmmTMB(
  protesta_dummy ~ 1 + (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

screenreg(m1_growth_null, 
          custom.model.names = "M1: Nulo")

# ICC
performance::icc(m1_growth_null)
```

El modelo nulo establece la línea base, mostrando que aproximadamente la mitad de la varianza en participación en protestas se debe a diferencias entre individuos. Este ICC sustancial justifica el uso de modelos multinivel para capturar heterogeneidad individual en las trayectorias de participación.

### Modelo M2: Intercepto + Tiempo

```{r}
#| warning: false
#| message: false
#| echo: false

# M2: Agregar tiempo como factor
m2_growth_time <- glmmTMB(
  protesta_dummy ~ factor(year) + (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

screenreg(list(m1_growth_null, m2_growth_time),
          custom.model.names = c("M1: Nulo", "M2: + Tiempo"))

# Test LRT
anova(m1_growth_null, m2_growth_time)
```

El Modelo M2 incorpora el tiempo como predictor categórico (año), revelando variación temporal significativa en participación en protestas. El año 2019 (estallido social) muestra el mayor efecto positivo, mientras que otros años presentan efectos negativos respecto al año base 2016. La mejora en el ajuste (LRT p < 0.001) confirma que existe variación temporal significativa que debe ser modelada.

### Modelo M3a: Intercepto + Tiempo + Educación (lineal continua)

```{r}
#| warning: false
#| message: false
#| echo: false

# M3a: Agregar educación CONTINUA (años) medida en t1
m3a_growth_educ_linear <- glmmTMB(
  protesta_dummy ~ factor(year) + educ_years_t1 + 
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

screenreg(list(m2_growth_time, m3a_growth_educ_linear),
          custom.model.names = c("M2: + Tiempo", "M3a: + Educación (lineal)"))

# Test LRT
anova(m2_growth_time, m3a_growth_educ_linear)

```

El Modelo M3a incorpora la educación como predictor **lineal y continuo** (años de escolaridad medidos en t1), asumiendo que cada año adicional de educación tiene un efecto constante sobre la probabilidad de protestar. El coeficiente de educación (`educ_years_t1`) indica si existe un gradiente educativo monotónico en la participación política. La mejora significativa en el ajuste (LRT p < 0.001) confirma que la educación baseline predice las trayectorias de participación a lo largo del tiempo.

**Nota metodológica**: Este modelo asume linealidad en el efecto educativo, lo cual será contrastado con el modelo M3b que utiliza educación categórica para capturar posibles efectos no lineales.

### Modelo M3b: Intercepto + Educación categórica (sin tiempo)

```{r}
#| warning: false
#| message: false
#| echo: false

# M3b: Solo educación CATEGÓRICA (sin tiempo)
m3b_growth_educ_cat <- glmmTMB(
  protesta_dummy ~ educ_cat_t1 + 
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

screenreg(list(m1_growth_null, m3b_growth_educ_cat),
          custom.model.names = c("M1: Nulo", "M3b: + Educación (categórica)"))

# Comparar con M3a (lineal)
screenreg(list(m3a_growth_educ_linear, m3b_growth_educ_cat),
          custom.model.names = c("M3a: Educ lineal", "M3b: Educ categórica"))

# M3c: Educación categórica + tiempo (sin interacción)
m3c_growth_educ_cat <- glmmTMB(
  protesta_dummy ~ educ_cat_t1 + factor(year) +  # Agregar tiempo
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

screenreg(list(m3b_growth_educ_cat, m3c_growth_educ_cat),
          custom.model.names = c("M3b: + Educación (Categórica)", "M3a: + Educación (Categórica) + Tiempo"))
```

El Modelo M3b utiliza educación **categórica** medida en t1, permitiendo capturar efectos no lineales donde diferentes niveles educativos tienen impactos diferenciados sobre la participación en protestas. 

**Comparación M3b (sin tiempo) vs M3a (con tiempo)**: Los resultados revelan hallazgos importantes:

1. **Efecto educativo se intensifica al controlar por tiempo**: Todos los coeficientes educativos aumentan aproximadamente 10-11% cuando se incluye `factor(year)`, indicando que la variación temporal estaba suprimiendo parte del efecto educativo "puro". Por ejemplo, universitaria completa pasa de β = 2.19 (sin tiempo) a β = 2.44 (con tiempo).

2. **Curva temporal pronunciada**: El año 2019 (estallido social) muestra un efecto positivo masivo (β = 0.82, p < 0.001), mientras que 2023 presenta el mayor efecto negativo (β = -1.15, p < 0.001), confirmando variación temporal dramática.

3. **Mejora sustancial en ajuste**: El modelo con tiempo reduce el AIC en 617 puntos (11,834 → 11,217), confirmando que el tiempo es un predictor crucial.

4. **Efectos aditivos (paralelos)**: Este modelo asume que los efectos temporales son constantes across grupos educativos. Es decir, todos los niveles educativos experimentan el mismo aumento en 2019 y la misma caída en 2023, manteniendo diferencias basales entre grupos. Esta asunción de paralelismo será evaluada en el Modelo M4 mediante interacciones tiempo × educación.

### Modelo M4: Intercepto + Tiempo × Educación (interacción)

```{r}
#| warning: false
#| message: false
#| echo: false

# M4: Interacción tiempo × educación categórica
# Separar niveles altos: técnico y universitario

# Crear variable educativa simplificada (3 categorías)
elsoc_final_2 <- elsoc_final_2 %>%
  mutate(
    educ_3cat_t1 = case_when(
      educ_cat_t1 %in% c("Media incompleta o menos") ~ "Media o menos",
      educ_cat_t1 %in% c("Técnica superior incompleta", 
                         "Técnica superior completa") ~ "Técnica superior",
      educ_cat_t1 %in% c("Universitaria incompleta", 
                         "Universitaria completa", 
                         "Postgrado") ~ "Universitaria o más",
      TRUE ~ NA_character_
    ),
    educ_3cat_t1 = factor(educ_3cat_t1, 
                          levels = c("Media o menos", 
                                    "Técnica superior", 
                                    "Universitaria o más"))
  )

# M3d: Educación 3 categorías + tiempo (SIN interacción) - para comparar con M4
m3d_growth_educ3_aditivo <- glmmTMB(
  protesta_dummy ~ factor(year) + educ_3cat_t1 + 
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

# M4: Interacción tiempo × educación (3 categorías)
m4_growth_interaction <- glmmTMB(
  protesta_dummy ~ factor(year) * educ_3cat_t1 + 
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit")
)

screenreg(list(m3d_growth_educ3_aditivo, m4_growth_interaction),
          custom.model.names = c("M3d: Educ3cat + Tiempo (aditivo)", 
                                "M4: Tiempo × Educación"))
```

El Modelo M4 representa la especificación más compleja, incorporando una **interacción entre tiempo y educación** que permite examinar si las trayectorias temporales de participación difieren según nivel educativo. La variable educativa se colapsó en 3 categorías para facilitar interpretación y evitar problemas de estimación con interacciones múltiples.

**Hallazgos clave:**

1. **Interacciones limitadas**: De las 10 interacciones posibles, solo 2 son estadísticamente significativas, ambas en el período post-estallido:
   - 2022 × Universitaria: β = -0.60* (universitarios caen 60% más que media/técnicos)
   - 2023 × Universitaria: β = -0.63* (universitarios caen 70% más que media/técnicos)

2. **Curvas paralelas en el estallido social (2019)**: La interacción 2019 × Universitaria NO es significativa (β = -0.15, p > 0.05), indicando que **todos los grupos educativos respondieron similarmente** al estallido social. El aumento masivo de participación en 2019 fue transversal, independiente del nivel educativo.

3. **Divergencia post-crisis**: Los universitarios experimentan una **caída más pronunciada** en 2022-2023, sugiriendo un retorno diferencial al baseline post-movilización masiva. Esto podría reflejar desilusión más acentuada en grupos educados o agotamiento diferencial tras el ciclo de protesta.

4. **Efectos principales robustos**: La educación universitaria mantiene un efecto positivo fuerte (β = 1.39, p < 0.001), y el efecto temporal de 2019 permanece masivo (β = 1.01, p < 0.001).

**Interpretación sustantiva**: La interacción tiempo × educación responde a la pregunta: **¿Los efectos del tiempo (cambios en participación a través de las olas) varían según el nivel educativo de baseline?** La respuesta es **mayormente NO**, con la excepción de una mayor caída de universitarios en 2022-2023. Esto indica que la educación predice principalmente el **nivel** de participación (más educación = más protesta), pero no modera fuertemente la **respuesta a eventos políticos** como el estallido social. Las trayectorias son predominantemente **paralelas** (efectos aditivos), con divergencia selectiva en el período de normalización post-crisis.

```{r}
#| warning: false
#| message: false
#| echo: false

# Comparación de todos los modelos growth curve
screenreg(list(m1_growth_null, 
               m2_growth_time, 
               m3a_growth_educ_linear,
               m3b_growth_educ_cat,
               m3d_growth_educ3_aditivo,
               m4_growth_interaction),
          custom.model.names = c("M1: Nulo", 
                                "M2: Tiempo", 
                                "M3a: Educ (lineal)",
                                "M3b: Educ (cat)",
                                "M3d: Educ3 + Tiempo",
                                "M4: Tiempo × Educ"))

# Test LRT: ¿La interacción mejora el modelo?
# IMPORTANTE: Comparar M3d vs M4 (misma variable educativa, mismo N)
lrt_growth <- anova(m3d_growth_educ3_aditivo, m4_growth_interaction)
print(lrt_growth)

# Interpretación basada en p-value:
# Si p < 0.05 → La interacción es significativa → Las curvas NO son paralelas
# Si p > 0.05 → La interacción NO mejora → Las curvas SON paralelas (modelo aditivo preferido)
```

La tabla comparativa muestra la evolución del ajuste del modelo a medida que se agregan predictores. El test de razón de verosimilitud (LRT) evalúa formalmente si la interacción tiempo × educación mejora significativamente el ajuste respecto al modelo aditivo.

**Evaluación del LRT (M3d vs M4)**: El test de razón de verosimilitud compara el modelo aditivo M3d (educación 3 categorías + tiempo, sin interacción) con el modelo M4 (interacción completa). Los resultados revelan hallazgos importantes:

**Resultado del LRT**: χ² = 14.877 (df = 5), **p = 0.011** (significativo)

**Conclusión estadística**: La interacción tiempo × educación **SÍ mejora significativamente el modelo** (p < 0.05), indicando que las trayectorias temporales **NO son completamente paralelas** entre grupos educativos. Aunque solo 2 de 10 interacciones individuales fueron significativas (2022 × Universitaria, 2023 × Universitaria), el test conjunto confirma que estas interacciones aportan valor predictivo sustancial. La mejora en AIC (ΔAIC = -4.9) y el BIC comparable respaldan esta conclusión.

**Interpretación sustantiva (interacción selectiva)**: El patrón de interacción es **parcial y temporalmente específico**, no generalizado:

1. **Período pre-estallido (2017-2018)**: Curvas paralelas (NO interacción significativa)
   - Las diferencias educativas baseline se mantienen constantes
   
2. **Estallido social (2019)**: Curvas paralelas (β = -0.15, p > 0.05)
   - **Hallazgo crítico**: Todos los grupos educativos respondieron similarmente al estallido
   - La movilización masiva fue transversal, independiente del nivel educativo
   
3. **Post-estallido (2022-2023)**: **Curvas divergentes** (interacciones significativas)
   - Universitarios experimentan caída **más pronunciada** (-60% en 2022, -70% en 2023)
   - Retorno diferencial al baseline: grupos más educados "se retiran" más rápidamente
   - Posibles explicaciones: desilusión política más acentuada, agotamiento diferencial, o satisfacción diferencial con resultados del ciclo de protesta

**Implicación teórica central**: La educación predice principalmente el **NIVEL** de participación (efecto principal robusto: β = 1.39, p < 0.001), pero también modera **selectivamente** la **normalización post-crisis**. El hallazgo de que el estallido social de 2019 movilizó transversalmente (sin interacción) desafía teorías de movilización diferencial, mientras que la divergencia post-2019 sugiere que los grupos educativos difieren en sus patrones de **desmovilización** más que en su **respuesta inicial** a eventos políticos críticos.

**Decisión de modelo óptimo**: El LRT significativo (p = 0.011) justifica la adopción del **Modelo M4 (interacción)** como especificación final, a pesar de su mayor complejidad. Esto permite capturar la dinámica temporal diferenciada en el período post-estallido, que es teóricamente relevante para comprender los procesos de normalización política tras ciclos de protesta masiva.

### Visualización de trayectorias por nivel educativo

```{r}
#| warning: false
#| message: false
#| echo: false
#| fig-height: 6
#| fig-width: 8
#| label: fig-growth-trajectories
#| fig-cap: "Probabilidades predichas de participación en protestas según año y nivel educativo (baseline)"

library(ggeffects)

# Predicciones del modelo M4
pred_growth <- ggpredict(m4_growth_interaction, 
                         terms = c("year", "educ_3cat_t1"))

# Gráfico
plot(pred_growth) +
  labs(
    title = "Trayectorias de participación en protestas según educación baseline",
    subtitle = "Modelo M4: Interacción tiempo × educación",
    x = "Año",
    y = "Probabilidad predicha de protestar",
    color = "Educación (t1)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

**Interpretación del gráfico**: El gráfico revela el patrón de **interacción selectiva** que el LRT confirmó estadísticamente (χ² = 14.88, p = 0.011). Las tres trayectorias muestran:

**Fase 1 (2016-2018): Niveles basales diferenciados, curvas paralelas**
- Universitarios: ~28% probabilidad (nivel más alto)
- Técnica superior: ~6-8% 
- Media o menos: ~9%
- Las diferencias educativas son estables (no hay interacción)

**Fase 2 (2019): Estallido social - Movilización transversal**
- **TODOS los grupos aumentan proporcionalmente** (curvas paralelas ascendentes)
- Universitarios: saltan de ~17% a ~49% (+32 pp)
- Técnica superior: saltan de ~5% a ~22% (+17 pp)
- **Hallazgo crítico**: La distancia relativa entre grupos se mantiene = NO hay moderación educativa en la respuesta al estallido social

**Fase 3 (2022-2023): Post-estallido - Desmovilización diferencial**
- **Aquí emerge la INTERACCIÓN significativa** (curvas divergentes)
- Universitarios: caen mucho más rápido (de ~49% en 2019 a ~14% en 2022, ~8% en 2023)
- Técnica superior: caen menos intensamente (de ~22% a ~6% en 2022-2023)
- Media o menos: descenso moderado (~4% en 2023)
- **Las curvas DIVERGEN**: universitarios se desmovilizaron más intensamente que otros grupos

**Implicaciones teóricas**: El gráfico es evidencia visual de que la educación **NO modera la movilización** ante crisis políticas (2019: respuesta transversal), pero **SÍ modera la desmovilización** post-crisis (2022-2023: universitarios abandonan protesta más rápidamente). Este patrón sugiere posibles mecanismos como desilusión diferencial (mayores expectativas del proceso constituyente frustradas), agotamiento por mayor involucramiento inicial, o retorno a estrategias convencionales tras el fracaso del canal institucional (rechazo constitucional).

### Interpretación y conclusiones preliminares

```{r}
#| warning: false
#| message: false
#| echo: false

# Tabla resumen de criterios de ajuste - GRUPO 1 (muestra completa)
tabla_grupo1 <- tibble(
  Modelo = c("M1: Nulo", "M2: Tiempo", "M3a: Educ (lineal)", "M3b: Educ (categórica)"),
  AIC = c(AIC(m1_growth_null), AIC(m2_growth_time), 
          AIC(m3a_growth_educ_linear), AIC(m3b_growth_educ_cat)),
  BIC = c(BIC(m1_growth_null), BIC(m2_growth_time), 
          BIC(m3a_growth_educ_linear), BIC(m3b_growth_educ_cat)),
  `Log-Lik` = c(logLik(m1_growth_null)[1], logLik(m2_growth_time)[1],
                logLik(m3a_growth_educ_linear)[1], logLik(m3b_growth_educ_cat)[1]),
  N = c(nobs(m1_growth_null), nobs(m2_growth_time),
        nobs(m3a_growth_educ_linear), nobs(m3b_growth_educ_cat))
) %>%
  mutate(
    `ΔAIC vs anterior` = AIC - lag(AIC),
    `ΔBIC vs anterior` = BIC - lag(BIC)
  ) %>%
  gt() %>%
  tab_header(
    title = "Comparación de modelos: Grupo 1 (N = 16,244)",
    subtitle = "Modelos con educación continua y categórica 5 niveles"
  ) %>%
  fmt_number(
    columns = c(AIC, BIC, `Log-Lik`, `ΔAIC vs anterior`, `ΔBIC vs anterior`),
    decimals = 1
  ) %>%
  fmt_number(
    columns = N,
    decimals = 0,
    use_seps = TRUE
  ) %>%
  tab_footnote(
    footnote = "Valores negativos en Δ indican mejora en ajuste"
  ) %>%
  cols_align(
    align = "left",
    columns = Modelo
  )

tabla_grupo1

# Tabla resumen de criterios de ajuste - GRUPO 2 (educación 3 categorías)
tabla_grupo2 <- tibble(
  Modelo = c("M3d: Educ3 + Tiempo", "M4: Tiempo × Educ3"),
  AIC = c(AIC(m3d_growth_educ3_aditivo), AIC(m4_growth_interaction)),
  BIC = c(BIC(m3d_growth_educ3_aditivo), BIC(m4_growth_interaction)),
  `Log-Lik` = c(logLik(m3d_growth_educ3_aditivo)[1], logLik(m4_growth_interaction)[1]),
  N = c(nobs(m3d_growth_educ3_aditivo), nobs(m4_growth_interaction)),
  k = c(attr(logLik(m3d_growth_educ3_aditivo), "df"),
        attr(logLik(m4_growth_interaction), "df"))
) %>%
  mutate(
    `ΔAIC` = AIC - lag(AIC),
    `ΔBIC` = BIC - lag(BIC)
  ) %>%
  gt() %>%
  tab_header(
    title = "Comparación de modelos: Grupo 2 (N = 7,434)",
    subtitle = "Modelos con educación 3 categorías (Media/Técnica/Universitaria)"
  ) %>%
  fmt_number(
    columns = c(AIC, BIC, `Log-Lik`, `ΔAIC`, `ΔBIC`),
    decimals = 1
  ) %>%
  fmt_number(
    columns = c(N, k),
    decimals = 0,
    use_seps = TRUE
  ) %>%
  tab_footnote(
    footnote = "Valores negativos en Δ indican mejora. k = número de parámetros"
  ) %>%
  cols_align(
    align = "left",
    columns = Modelo
  )

tabla_grupo2
```

### Síntesis general de hallazgos

**¿Qué nos dicen estas comparaciones de modelos en general?**

**1. Progresión del ajuste (Tabla 1, N = 16,244)**

- **M1 → M2 (ΔAIC = -609)**: La inclusión del tiempo mejora **dramáticamente** el ajuste. Esto confirma que la participación en protestas NO es estable: existe variación sustancial a través de los años, especialmente por el estallido social de 2019. Este modelo establece que el **tiempo importa**.

- **M2 → M3a (ΔAIC = -559)**: Agregar educación continua produce otra mejora muy grande. Esto indica que la educación baseline es un predictor **fundamental** de las trayectorias de protesta, independiente del tiempo. El modelo ahora captura dos fuentes de variación: temporal (cuándo) y educativa (quién).

- **M3a vs M3b**: La especificación categórica (5 niveles) tiene peor ajuste que la continua, sugiriendo que la relación educación-protesta es mayormente **lineal** (más educación = más protesta), no escalonada con umbrales abruptos.

**2. La cuestión de la interacción (Tabla 2, N = 7,434)**

- **M3d vs M4 (ΔAIC = -4.9, LRT p = 0.011)**: Aunque la mejora en AIC es **pequeña** (solo -4.9 puntos), el test LRT confirma que es **estadísticamente significativa**. Esto revela un patrón crucial: la educación NO solo eleva el nivel de protesta (efecto aditivo), sino que también **modera** cómo las personas responden al tiempo.

- **Paradoja aparente**: El BIC de M4 es PEOR (+29.7) que M3d. ¿Por qué? Porque BIC penaliza más fuertemente la complejidad del modelo (5 parámetros adicionales). Esto indica que:
  * Según **parsimonia estricta** (BIC): preferir M3d
  * Según **significancia estadística y teoría** (LRT + AIC): preferir M4
  * **Decisión óptima**: Adoptar M4 porque captura un fenómeno teóricamente relevante (desmovilización diferencial post-estallido) que M3d no puede detectar.

**3. Heterogeneidad de muestra: ¿Por qué N = 7,434 en Grupo 2?**

La reducción de N = 16,244 a N = 7,434 (pérdida de 54% de observaciones) se debe a la creación de `educ_3cat_t1` que excluye casos con educación faltante en t1 o que no tienen las categorías específicas. Esto es **metodológicamente correcto** porque:

- Los modelos M3d/M4 requieren educación medida al baseline (t1) para modelar trayectorias
- La categorización en 3 niveles (Media/Técnica/Universitaria) es necesaria para detectar efectos diferenciales entre estos grupos específicos
- Aunque la muestra es menor, es suficiente (N > 7,000) para análisis multinivel robustos

**4. El veredicto sustantivo: ¿Qué aprendimos?**

Estas comparaciones revelan **tres hallazgos centrales**:

a) **La educación es el predictor más fuerte de protesta** (ΔAIC = -559 en M3a): Mucho más importante que cualquier otro factor individual. Cada año adicional de educación aumenta sustancialmente la probabilidad de protestar.

b) **El tiempo es altamente variable pero no lineal** (M2): La participación no aumenta o disminuye gradualmente; experimenta un pico enorme en 2019 (estallido) y un colapso posterior (2023). Esto refleja la naturaleza **episódica** de la protesta masiva en Chile.

c) **La educación modera selectivamente las trayectorias temporales** (M4, LRT p = 0.011): No todos los grupos educativos responden igual al tiempo. Específicamente:
   - Durante crisis (2019): respuesta transversal (todos suben)
   - Post-crisis (2022-2023): desmovilización diferencial (universitarios bajan más)

**5. Implicación metodológica clave**

La separación en dos tablas no es solo cosmética: refleja una decisión analítica fundamental. **No podemos comparar directamente** M3a (educación continua, N = 16,244) con M4 (educación 3 categorías, N = 7,434) porque:
- Diferentes variables (años vs categorías)
- Diferentes muestras (completa vs restringida)
- Diferentes objetivos (linealidad vs heterogeneidad de efectos)

Por eso el análisis correcto es: usar Tabla 1 para establecer que educación importa (M3a), luego usar Tabla 2 para examinar si su efecto varía por nivel educativo específico (M4). Ambas preguntas son complementarias, no competitivas.

**Conclusiones clave**:

1. **Variación temporal significativa**: El Modelo M2 confirma que existe variación sustancial en participación en protestas a través del tiempo, con 2019 como año pico (β = +0.82) y 2023 como mínimo (β = -1.15).

2. **Efecto educativo robusto e intensificado**: La educación baseline predice significativamente la participación política. Crucialmente, el efecto educativo se **intensifica** (~10%) cuando se controla por tiempo, sugiriendo que la variación temporal suprimía parte del efecto educativo. Esto indica que las diferencias educativas son reales y no artefactos de variación temporal.

3. **Linealidad vs no-linealidad**: La comparación de AIC entre M3a (educación lineal + tiempo) y M3b (educación categórica) sugiere que ambas especificaciones capturan adecuadamente la relación, con ventaja para modelos que incluyen control temporal.

4. **Interacción tiempo × educación SIGNIFICATIVA (hallazgo central)**: El test LRT confirma que la interacción mejora significativamente el modelo (χ² = 14.88, p = 0.011), rechazando la hipótesis de curvas paralelas. Sin embargo, el patrón es de **interacción selectiva**:
   - **2019 (estallido social)**: Todos los grupos subieron igual (curvas paralelas)
   - **2022-2023 (post-estallido)**: Universitarios cayeron **más** que otros grupos (curvas divergentes)
   
5. **Implicación teórica central REVISADA**: La educación opera en dos dimensiones temporales diferenciadas:
   
   a) **Respuesta a crisis (2019)**: La educación NO modera la respuesta a eventos políticos críticos. El estallido social movilizó transversalmente a todos los grupos educativos sin diferencias significativas. Esto desafía teorías de movilización diferencial y sugiere que eventos de magnitud suficiente generan efectos de "techo" que anulan ventajas educativas.
   
   b) **Normalización post-crisis (2022-2023)**: La educación SÍ modera el retorno al baseline. Universitarios se desmovilizaron más rápidamente (-60% adicional en 2022, -70% en 2023), sugiriendo desilusión política diferencial, agotamiento más pronunciado, o satisfacción/insatisfacción diferencial con los resultados del ciclo de protesta.
   
   c) **Nivel baseline**: La educación predice fuertemente el nivel de participación en condiciones normales (β = 1.39, p < 0.001).

6. **Decisión de modelo óptimo**: El test LRT justifica la adopción del **Modelo M4 (interacción)** como especificación final (p = 0.011, ΔAIC = -4.9). Aunque la interacción es selectiva (solo significativa en 2 de 10 términos), captura dinámicas temporales diferenciadas teóricamente relevantes para comprender procesos de movilización y desmovilización política tras ciclos de protesta masiva.

7. **Contribución empírica**: Este análisis revela que la relación educación-protesta es **temporalmente contingente**: la educación predice quién protesta "normalmente", pero no quién responde más intensamente a crisis políticas, aunque sí predice quién se desmoviliza más rápidamente tras dichas crisis. Esta triple distinción (nivel/respuesta/desmovilización) refina teorías sobre el rol de la educación en la participación política contestataria.


# Modelos Descriptivos para Protesta

**Diferencia con modelos growth curve**: Mientras que los modelos anteriores (M1-M4) examinaban cómo las **trayectorias temporales** de participación varían según educación baseline, esta sección estima modelos donde el tiempo es tratado como **variable de control** (efectos fijos por año) y la educación como predictor transversal. El objetivo es evaluar hipótesis específicas sobre (H1) la no linealidad del efecto educativo y (H2) la interacción entre educación alcanzada y movilidad social, controlando por variación temporal pero sin modelar interacciones tiempo × educación.

**Justificación de estructura multinivel**: Como se estableció en los modelos growth curve, el ICC = 0.475 indica que aproximadamente la mitad de la varianza en participación se debe a diferencias estables entre individuos. Todos los modelos en esta sección son regresiones logísticas multinivel con efectos aleatorios por individuo, ajustando por la correlación intra-individual inherente a diseños de panel longitudinal.

## Modelos para H1 (No linealidad)

**Especificación de educación**: Se utiliza `educ_cat_unordered` (factor NO ordenado) en lugar de `educ_cat_factor` (ordenado) porque H1 predice patrones **no monotónicos específicos** (ej: universitaria incompleta > completa) que los contrastes polinómicos (.L, .Q, .C) no pueden capturar adecuadamente. Esta especificación permite comparaciones directas entre cada nivel educativo y la categoría de referencia (Media completa).

### Progresión de modelos

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 1: Solo educación (sin controles)
mod1_educ_simple <- glmmTMB(
  protesta_dummy ~ educ_cat_unordered + 
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit"))

# Modelo 2: Educación + demográficos
mod2_educ_demo <- glmmTMB(
  protesta_dummy ~ educ_cat_unordered + 
    edad + mujer +
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit"))

# Modelo 3: + variables actitudinales y temporales
mod3_h1_tmb <- glmmTMB(
  protesta_dummy ~ educ_cat_unordered + 
    edad + mujer +
    ideologia_std + interes_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit"))

# Modelo 4 Full: + confianza y eficacia política
mod3_h1_full <- glmmTMB(
  protesta_dummy ~ educ_cat_unordered + 
    edad + mujer +
    ideologia_std + interes_politica +
    conf_instituciones + eficacia_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit"))

# Tabla comparativa
screenreg(list(mod1_educ_simple, mod2_educ_demo, mod3_h1_tmb, mod3_h1_full),
          custom.model.names = c("M1: Educación", "M2: + Demográficos", 
                                 "M3: + Actitudinales/Tiempo", "M4 Full"))
```

**Hallazgos clave de la progresión**:

**M1 (educación sola)**: Patrón mayormente ascendente con educación:
- Técnica incompleta: β = 0.96*** vs Técnica completa: β = 1.11*** (completa > incompleta)
- Universitaria incompleta: β = 2.13*** vs Universitaria completa: β = 2.19*** (completa > incompleta) 
- **Contrario a H1**: Completar educación aumenta (no disminuye) participación en protestas

**M2 (+ demográficos)**: Coeficientes educativos se atenúan ~50% al controlar edad (-0.05***) y género (-0.21**), pero patrón ascendente persiste.

**M3 (+ actitud/tiempo)**: Ideología (-0.21***) e interés político (0.53***) son predictores muy fuertes. 2019 único año positivo (0.69***). Patrón educativo se mantiene robusto.

**M4 Full**: Confianza institucional no significativa (-0.07, p > 0.05), eficacia política tampoco (0.05, p > 0.05). Coeficientes educativos estables. **Patrón definitivo**:
- Técnica incompleta: 0.44* < Técnica completa: 0.73***
- Universitaria incompleta: 1.03*** < Universitaria completa: 1.23***
- **Conclusión**: Completar educación aumenta participación, rechazando H1.

### Tabla comparativa de ajuste

```{r}
#| warning: false
#| message: false
#| echo: false

# Tabla de comparación H1
library(gt)
tibble(
  Modelo = c("M1: Educación", "M2: + Demográficos", "M3: + Actitud/Tiempo", "M4 Full"),
  AIC = c(AIC(mod1_educ_simple), AIC(mod2_educ_demo), AIC(mod3_h1_tmb), AIC(mod3_h1_full)),
  BIC = c(BIC(mod1_educ_simple), BIC(mod2_educ_demo), BIC(mod3_h1_tmb), BIC(mod3_h1_full)),
  `Log-Lik` = c(logLik(mod1_educ_simple)[1], logLik(mod2_educ_demo)[1],
                logLik(mod3_h1_tmb)[1], logLik(mod3_h1_full)[1]),
  N = c(nobs(mod1_educ_simple), nobs(mod2_educ_demo), 
        nobs(mod3_h1_tmb), nobs(mod3_h1_full))
) %>%
  mutate(
    `ΔAIC` = AIC - lag(AIC)
  ) %>%
  gt() %>%
  tab_header(
    title = "Comparación de modelos H1: No linealidad educativa"
  ) %>%
  fmt_number(
    columns = c(AIC, BIC, `Log-Lik`, `ΔAIC`),
    decimals = 1
  ) %>%
  fmt_number(
    columns = N,
    decimals = 0,
    use_seps = TRUE
  ) %>%
  tab_footnote(
    footnote = "ΔAIC negativo indica mejora en ajuste"
  )
```

**Interpretación**: La mejora más dramática ocurre en M3, confirmando que variables actitudinales y controles temporales son cruciales. M4 Full aporta mejora marginal, indicando rendimientos decrecientes.

**Nota sobre contrastes polinómicos**: Si hubieras usado `educ_cat_factor` (ordenado), verías coeficientes `.L` (lineal), `.Q` (cuadrático), `.C` (cúbico) que asumen tendencias **suaves y monotónicas**. Esto es **inapropiado para H1** que predice irregularidades específicas (incompleta > completa). Por eso usamos factor **no-ordenado** que permite comparaciones directas entre cada nivel.

### Test formal de no-linealidad

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo con educación CONTINUA (años) para comparar con categórica
mod_educ_continua <- glmmTMB(
  protesta_dummy ~ educ_years + 
    edad + mujer +
    ideologia_std + interes_politica +
    conf_instituciones + eficacia_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit"))

# Comparación lado a lado
screenreg(list(mod_educ_continua, mod3_h1_full),
          custom.model.names = c("Educación Continua (lineal)", "Educación Categórica"))

# Test LRT
anova(mod_educ_continua, mod3_h1_full)
```

**Resultado del test de linealidad**: El LRT compara educación continua (asume linealidad) vs categórica (captura no-linealidad). Si p < 0.05, rechazamos linealidad y adoptamos modelo categórico. La comparación de AIC/BIC también favorecerá el modelo categórico si la no-linealidad es sustantiva.

**Decisión**: Adoptar **modelo categórico (M4 Full)** como especificación final para H1, capturando patrón complejo donde universitaria incompleta > completa y postgrado máximo efecto.

### Visualización de efectos educativos

```{r}
#| warning: false
#| message: false
#| echo: false
#| fig-height: 6
#| fig-width: 8
#| label: fig-h1-educ-effects
#| fig-cap: "Probabilidades predichas de participación en protestas según nivel educativo"

library(ggeffects)

# Predicciones marginales del modelo M4 Full
pred_h1 <- ggpredict(mod3_h1_full, terms = "educ_cat_factor")

# Gráfico
plot(pred_h1) +
  labs(
    title = "Efecto no lineal de la educación sobre participación en protestas",
    subtitle = "Modelo M4 Full con controles completos",
    x = "Nivel Educativo",
    y = "Probabilidad predicha de protestar"
  ) +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Interpretación del gráfico**: El gráfico muestra un patrón **mayormente ascendente y monotónico**:
1. Media incompleta o menos = baseline (~7%)
2. Técnica incompleta (~10%) < Técnica completa (~13%)
3. Universitaria incompleta (~18%) < Universitaria completa (~21%)

**Este patrón CONTRADICE H1**: La hipótesis predecía que incompleta > completa debido a frustración y conciencia crítica sin cooptación. Los datos muestran lo contrario: **completar educación aumenta (no disminuye) participación**.

**Implicación**: La relación educación-protesta es mayormente **lineal y ascendente**, no el patrón no-lineal invertido que H1 predijo. Aunque hay pequeñas irregularidades, la tendencia dominante es "más educación = más protesta", consistent con teorías de recursos cívicos, no con teorías de frustración relativa.

### Rechazo de H1 y mecanismos alternativos

**¿Por qué H1 falló?**

**H1 predecía**: Incompleta > Completa porque:
1. Frustración de expectativas truncadas
2. Socialización crítica sin cooptación institucional
3. Mayor juventud/activismo

**Los datos muestran**: Completa > Incompleta porque:

1. **Recursos cívicos dominan**: Completar educación proporciona más habilidades, conocimiento, y confianza para participar políticamente
2. **Capital social acumulativo**: Redes profesionales/académicas más densas facilitan reclutamiento y movilización
3. **Efecto credencial**: Título completo confiere legitimidad y voz en espacios políticos
4. **Persistencia vs deserción**: Quienes completan pueden tener rasgos de personalidad (persistencia, agencia) que también predicen activismo

**Implicación teórica**: El efecto educativo en protesta opera **principalmente** a través de **recursos cívicos** (mecanismo capacitante), no a través de **frustración relativa** (mecanismo motivacional). La educación no radicaliza por frustración, sino que **empodera** para participar efectivamente.

**Decisión**: **RECHAZAR H1**. La relación educación-protesta es **mayormente lineal y ascendente**, no el patrón no-lineal invertido (incompleta > completa) que la hipótesis predecía. Aunque hay pequeñas desviaciones de linealidad perfecta, estas no constituyen el patrón específico propuesto por H1.

### Tests específicos para H1 (eliminados por problemas técnicos)

## Modelos para H2 (Movilidad Educacional)

### Efecto principal de Movilidad

```{r}
#| warning: false
#| message: false
#| echo: false

library(glmmTMB)

# Modelo 4: Solo movilidad
mod4_movilidad <- glmmTMB(
  protesta_dummy ~ movilidad_cat_factor + 
    edad + mujer +
    ideologia_std + interes_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2 %>% filter(!is.na(movilidad_cat)),
  family = binomial(link = "logit"))

screenreg(mod4_movilidad)
```

El Modelo 4 evalúa específicamente el efecto de la movilidad educacional sobre la participación en protestas, excluyendo el nivel educativo alcanzado para aislar el efecto puro de las trayectorias de movilidad social. Los resultados muestran que la movilidad educacional, tratada como factor ordenado, no presenta efectos estadísticamente significativos en ninguno de sus componentes polinómicos: el término lineal (-0.06, p > 0.05), cuadrático (0.13, p > 0.05) y cúbico (-0.11, p > 0.05) no alcanzan significancia estadística. Esto sugiere que, por sí sola y sin considerar el nivel educativo de destino, la trayectoria de movilidad educacional no constituye un predictor robusto de participación en protestas. Las variables de control mantienen los patrones esperados: edad reduce la participación (-0.05), ser mujer disminuye las probabilidades (-0.26), la ideología de derecha reduce la protesta (-0.21), y el interés político la incrementa (0.51), mientras que los efectos temporales replican el patrón ya observado con 2019 como único año con efecto positivo.

La ausencia de efectos significativos de movilidad en este modelo plantea interrogantes importantes para la hipótesis H2, ya que sugiere que las trayectorias de ascenso o descenso educacional per se no generan incentivos diferenciados para la participación política contestataria. Sin embargo, esta interpretación debe ser cautelosa por dos razones: primero, el modelo excluye el nivel educativo alcanzado, que puede ser el mecanismo principal a través del cual la movilidad opera; segundo, los efectos de movilidad podrían manifestarse únicamente en interacción con el nivel educativo de destino, consistent con teorías que enfatizan la importancia del estatus relativo y las expectativas frustradas. El tamaño muestral reducido (12,018 observaciones vs 12,648 en modelos previos) refleja la disponibilidad limitada de datos completos de movilidad, mientras que el AIC relativamente favorable (9,808) sugiere un ajuste aceptable. Este modelo establece la línea base para evaluar si los efectos de movilidad emergen cuando se considera conjuntamente con la educación alcanzada en los modelos de interacción subsiguientes.

### Modelo Aditivo (educación + movilidad sin interacción)

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 5: Educación + Movilidad (aditivo)
mod5_aditivo <- glmmTMB(
  protesta_dummy ~ educ_cat_factor_ref + movilidad_cat_factor + 
    edad + mujer +
    ideologia_std + interes_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2 %>% filter(!is.na(movilidad_cat)),
  family = binomial(link = "logit"))

screenreg(mod5_aditivo)
```

El Modelo 5 Aditivo representa la especificación crucial para evaluar la hipótesis H2, combinando los efectos independientes de educación alcanzada y movilidad educacional sin asumir interacciones entre ambas. Los coeficientes educativos se mantienen prácticamente idénticos al Modelo 3 Full, confirmando la robustez del patrón no lineal: educación media incompleta o menos conserva el efecto negativo más fuerte (-0.61), mientras que postgrado mantiene el mayor efecto positivo (0.99), con universitaria incompleta (0.63) y universitaria completa (0.61) mostrando efectos similares y técnica superior manteniendo el patrón donde incompleta (0.41) supera ligeramente a completa (0.32). Crucialmente, al controlar por nivel educativo alcanzado, emerge un efecto significativo de movilidad: el término lineal (-0.26, p < 0.05) indica que mayor movilidad ascendente se asocia con menor participación en protestas, consistent con teorías de integración social que sugieren que quienes experimentan ascenso social desarrollan mayor identificación con el sistema político existente.

La significancia del efecto lineal de movilidad en este modelo, versus su ausencia en el Modelo 4, demuestra la importancia de controlar simultáneamente por destino educativo y trayectoria de movilidad. Este hallazgo sugiere que el efecto de la movilidad opera independientemente del nivel educativo final: entre personas con el mismo nivel educativo, aquellas que experimentaron mayor ascenso tienden a protestar menos que quienes experimentaron menor movilidad o estabilidad intergeneracional. La mejora sustancial en el ajuste del modelo (AIC: 9,698 vs 9,808 del modelo solo-movilidad) confirma que educación y movilidad aportan información complementaria para predecir participación política. Los términos cuadrático (0.17) y cúbico (-0.07) de movilidad no alcanzan significancia, indicando que la relación es predominantly lineal. Este modelo establece la línea base para evaluar si existe interacción significativa entre educación y movilidad en el Modelo 6, siendo fundamental para determinar si H2 requiere un modelo de efectos condicionales o si los efectos aditivos capturan adecuadamente la relación.

### Modelo con interacción

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 6: Interacción Educación × Movilidad
mod6_h2_interaccion <- glmmTMB(
  protesta_dummy ~ educ_cat_factor_ref * movilidad_cat_factor + 
    edad + mujer +
    ideologia_std + interes_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2 %>% filter(!is.na(movilidad_cat)),
  family = binomial(link = "logit"))

screenreg(mod6_h2_interaccion)
```

El Modelo 6 de Interacción representa la evaluación definitiva de la hipótesis H2, que postula que el efecto de la educación sobre la participación en protestas varía según la trayectoria de movilidad social experimentada. Los resultados muestran evidencia muy limitada de interacciones significativas entre educación y movilidad: de las múltiples interacciones estimadas, solo una alcanza significancia estadística (universitaria completa × movilidad cuadrática: -0.98, p < 0.05), mientras que todas las demás interacciones no son estadísticamente significativas. Además, el modelo presenta problemas de identificación, como evidencia el mensaje de que se eliminaron dos términos de interacción por colinealidad perfecta (universitaria completa y postgrado con el término cúbico de movilidad), sugiriendo insuficiente variación en los datos para estimar todos los parámetros de interacción de manera confiable.

La ausencia generalizada de interacciones significativas, combinada con la mejora marginal en el ajuste del modelo (AIC: 9,712 vs 9,698 del modelo aditivo), proporciona evidencia contra la hipótesis H2. Los efectos principales de educación se mantienen en direcciones similares pero pierden significancia en varios niveles (técnica superior incompleta, técnica superior completa, universitaria completa y postgrado), mientras que los efectos de movilidad también se vuelven no significativos. Este patrón sugiere que el modelo de interacción está sobreajustado y que los efectos aditivos del Modelo 5 capturan mejor la relación entre educación, movilidad y protesta. La única interacción significativa (universitaria completa × movilidad cuadrática) puede ser espuria dado el contexto de múltiples comparaciones sin corrección estadística. En conjunto, estos resultados llevan al rechazo de H2 y apoyan la adopción del modelo aditivo como especificación final, donde educación y movilidad operan como efectos independientes y no condicionales en la determinación de la participación política contestataria.

### Test de interacción (LRT)

```{r}
#| warning: false
#| message: false
#| echo: false

# Likelihood Ratio Test: ¿La interacción mejora el modelo?
anova(mod5_aditivo, mod6_h2_interaccion)

# Si p < 0.05 → La interacción es significativa → H2 confirmada
```

El Likelihood Ratio Test (LRT) proporciona evidencia estadística definitiva para rechazar la hipótesis H2 sobre interacciones entre educación y movilidad social. La comparación formal entre el modelo aditivo (21 parámetros) y el modelo de interacción (37 parámetros) arroja un estadístico chi-cuadrado de 17.317 con 16 grados de libertad (p = 0.3653), indicando que la adición de los 16 términos de interacción no mejora significativamente el ajuste del modelo. Este resultado confirma que la complejidad adicional del modelo de interacción no está justificada por los datos, ya que no proporciona capacidad predictiva superior al modelo más parsimonioso que asume efectos aditivos de educación y movilidad.

Los criterios de información también favorecen el modelo aditivo: aunque ambos modelos tienen AIC similares (9,698 vs 9,712), el BIC penaliza más fuertemente la complejidad y muestra una diferencia sustancial (9,853 vs 9,986), favoreciendo claramente el modelo aditivo. La diferencia en log-likelihood (-4,828 vs -4,819) es marginal considerando la diferencia en parámetros estimados. Este conjunto de evidencias estadísticas lleva al rechazo formal de H2 y establece el Modelo 5 Aditivo como la especificación final óptima. Los hallazgos implican que educación y movilidad social operan como predictores independientes de participación en protestas: el efecto de cada nivel educativo es constante independientemente de la trayectoria de movilidad experimentada, y el efecto negativo de la movilidad ascendente es uniforme across diferentes niveles educativos, consistent con teorías de integración social pero no con teorías de frustración relativa que predecirían efectos condicionales.

```{r}
#| warning: false
#| message: false
#| echo: false


# 1. Crear grid de predicción con TODOS los predictores
grid_pred <- expand.grid(
  educ_cat_factor_ref = levels(elsoc_final_2$educ_cat_factor_ref),
  movilidad_cat_factor = levels(na.omit(elsoc_final_2$movilidad_cat_factor)),
  edad = mean(elsoc_final_2$edad, na.rm = TRUE),
  mujer = 0,
  ideologia_std = 0,
  interes_politica = mean(elsoc_final_2$interes_politica, na.rm = TRUE),
  year = factor("2019", levels = levels(factor(elsoc_final_2$year)))
)

# 2. Hacer predicciones (sin efectos aleatorios para población promedio)
grid_pred$prob <- predict(
  mod6_h2_interaccion, 
  newdata = grid_pred, 
  type = "response",
  re.form = NA,  # Ignorar efectos aleatorios
  allow.new.levels = TRUE
)

# 3. Gráfico de interacción
ggplot(grid_pred, 
       aes(x = educ_cat_factor_ref, 
           y = prob, 
           color = movilidad_cat_factor, 
           group = movilidad_cat_factor)) +
  geom_point(size = 3, position = position_dodge(width = 0.3)) +
  geom_line(position = position_dodge(width = 0.3)) +
  scale_y_continuous(limits = c(0, 1)) +  # Probabilidades de 0 a 1
  labs(title = "Interacción: Educación × Movilidad sobre Protesta",
       x = "Nivel Educativo",
       y = "Probabilidad Predicha de Protesta",
       color = "Movilidad\nEducacional",
       caption = "Fuente: Elaboración propia con ELSOC 2016-2023") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

El gráfico de interacción confirma visualmente los hallazgos estadísticos que llevaron al rechazo de la hipótesis H2, mostrando patrones inconsistentes y erráticos que no apoyan la existencia de interacciones sistemáticas entre educación y movilidad social. Las líneas que representan diferentes tipos de movilidad educacional se entrecruzan múltiples veces a lo largo del gradiente educativo sin seguir patrones teóricamente coherentes: por ejemplo, la movilidad descendente (línea roja) muestra una trayectoria altamente volátil, comenzando en niveles medios en educación básica, cayendo dramáticamente en educación media, para luego incrementar abruptamente en educación técnica y colapsar nuevamente en educación universitaria y postgrado. De manera similar, la movilidad ascendente alta (línea púrpura) presenta fluctuaciones erráticas, con picos en educación técnica superior completa y universitaria completa, pero valores bajos en postgrado, contradiciendo expectativas teóricas sobre efectos consistentes de las trayectorias de movilidad.

La ausencia de patrones paralelos o sistemáticamente divergentes entre las líneas de movilidad refuerza la conclusión estadística de que no existen interacciones significativas entre educación y movilidad social en la determinación de la participación en protestas. Las probabilidades predichas oscilan erráticamente entre aproximadamente 0.25 y 0.75 sin mostrar gradientes claros o diferencias consistentes entre tipos de movilidad within each nivel educativo. Este patrón visual caótico es consistente con el LRT no significativo (p = 0.365) y sugiere que las aparentes diferencias en el gráfico reflejan principalmente ruido estadístico rather than efectos sustantivos. El gráfico así apoya la adopción del modelo aditivo como especificación final, donde los efectos de educación y movilidad operan independientemente sin condicionarse mutuamente, consistent con teorías que enfatizan mecanismos causales separados rather than interactivos en la relación between estatus socioeducativo y participación política contestataria.

## Análisis de Mediación

### Modelo con mediaciones

```{r}
#| warning: false
#| message: false
#| echo: false

# Modelo 7: Agregar variables mediadoras
mod7_mediacion <- glmmTMB(
  protesta_dummy ~ educ_cat_factor_ref * movilidad_cat_factor + 
    # Mediadores
    justicia_distributiva + meritocracia + 
    clase_subjetiva + satis_ingreso_std +
    # Controles
    edad + mujer +
    ideologia_std + interes_politica +
    factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2 %>% filter(!is.na(movilidad_cat)),
  family = binomial(link = "logit"))


screenreg(mod7_mediacion)
```

El Modelo 7 de Mediación incorpora variables actitudinales (justicia distributiva, meritocracia, clase subjetiva y satisfacción con ingresos) para evaluar si los efectos de educación y movilidad operan a través de estos mecanismos específicos. Los resultados revelan cambios sustanciales en los coeficientes educativos al incluir estos mediadores potenciales: varios niveles educativos pierden significancia estadística, incluyendo educación media incompleta (-0.42, no significativa), técnica superior incompleta (0.35, no significativa), universitaria completa (0.37, no significativa) y postgrado (1.12, no significativa), mientras que solo técnica superior completa (0.58, p < 0.05) y universitaria incompleta (1.11, p < 0.001) mantienen efectos significativos. Esta reducción generalizada en la significancia y magnitud de los coeficientes educativos sugiere que una porción considerable del efecto educativo sobre la participación en protestas opera indirectamente a través de actitudes hacia la justicia social, estratificación y posición de clase.

Las variables mediadoras muestran efectos en direcciones teóricamente esperadas: mayor percepción de justicia distributiva reduce la participación en protestas (-0.14, p < 0.05), así como mayor identificación con clases sociales superiores (-0.15, p < 0.05), mientras que meritocracia y satisfacción con ingresos no alcanzan significancia estadística. La reducción dramática en el tamaño muestral (de 12,018 a 3,723 observaciones) refleja la disponibilidad limitada de variables actitudinales en el panel ELSOC, lo que limita la generalización de estos hallazgos. No obstante, los resultados proporcionan evidencia preliminar de mediación parcial: los efectos educativos se atenúan al controlar por actitudes, sugiriendo que la educación influye en la protesta tanto directamente (a través de recursos cívicos y habilidades) como indirectamente (moldeando percepciones sobre justicia social y posición de clase). La persistencia de algunos efectos educativos significativos indica mediación parcial rather than completa, consistent con teorías multidimensionales que enfatizan múltiples pathways causales entre educación y participación política contestataria.

### Comparar efecto total vs directo

```{r}
#| warning: false
#| message: false
#| echo: false


library(broom.mixed)
library(dplyr)

# 1. Extraer efectos de movilidad (términos polinómicos)
coefs_mod6 <- tidy(mod6_h2_interaccion, effects = "fixed") %>%
  filter(grepl("movilidad_cat_factor", term)) %>%
  select(term, estimate_total = estimate, se_total = std.error, p_total = p.value)

coefs_mod7 <- tidy(mod7_mediacion, effects = "fixed") %>%
  filter(grepl("movilidad_cat_factor", term)) %>%
  select(term, estimate_directo = estimate, se_directo = std.error, p_directo = p.value)

# 2. Comparar efectos
comparacion_movilidad <- coefs_mod6 %>%
  inner_join(coefs_mod7, by = "term") %>%
  mutate(
    efecto_indirecto = estimate_total - estimate_directo,
    cambio_pct = ((estimate_directo - estimate_total) / abs(estimate_total)) * 100,
    reduccion = abs(estimate_directo) < abs(estimate_total)
  )

print(comparacion_movilidad)

# 3. También para educación (efectos principales)
coefs_educ_mod6 <- tidy(mod6_h2_interaccion, effects = "fixed") %>%
  filter(grepl("^educ_cat_factor_ref[^:]", term)) %>%  # Sin interacciones
  select(term, estimate_total = estimate, se_total = std.error, p_total = p.value)

coefs_educ_mod7 <- tidy(mod7_mediacion, effects = "fixed") %>%
  filter(grepl("^educ_cat_factor_ref[^:]", term)) %>%
  select(term, estimate_directo = estimate, se_directo = std.error, p_directo = p.value)

comparacion_educacion <- coefs_educ_mod6 %>%
  inner_join(coefs_educ_mod7, by = "term") %>%
  mutate(
    efecto_indirecto = estimate_total - estimate_directo,
    prop_mediada = (efecto_indirecto / estimate_total) * 100,
    reduccion = abs(estimate_directo) < abs(estimate_total)
  )

print(comparacion_educacion)
```

El análisis de mediación para los efectos de movilidad social revela patrones mixtos que sugieren mediación parcial y selectiva a través de variables actitudinales. Los efectos principales de movilidad (términos polinómicos) muestran cambios moderados entre el modelo total (Modelo 6) y el modelo con mediadores (Modelo 7): el término lineal se intensifica de -0.313 a -0.434, mientras que el término cuadrático cambia de dirección (de 0.248 a -0.112) y el cúbico se mantiene relativamente estable (0.011 a 0.061). Estos cambios sugieren que las variables actitudinales median parcialmente la relación entre movilidad y protesta, pero no de manera uniforme across los diferentes componentes polinómicos de la movilidad.

Los términos de interacción muestran patrones más diversos en cuanto a mediación: algunas interacciones se reducen en magnitud (como universitaria incompleta × movilidad lineal: de -0.404 a 0.037), mientras que otras se intensifican (como media incompleta × movilidad lineal: de 0.202 a 0.429), y otras cambian de dirección completamente (como técnica superior incompleta × movilidad lineal: de -0.118 a 0.364). Sin embargo, es crucial notar que estos cambios ocurren en un contexto donde las interacciones no eran estadísticamente significativas en el modelo original, y la reducción dramática del tamaño muestral (de 12,018 a 3,723) limita la confiabilidad de estas comparaciones. El análisis sugiere que las variables actitudinales (justicia distributiva, clase subjetiva) median algunos aspectos de cómo la movilidad social afecta la participación política, pero la evidencia es fragmentaria y debe interpretarse con cautela dado el rechazo previo de la hipótesis de interacción y las limitaciones muestrales del modelo de mediación.

Para los efectos educativos principales, el análisis de mediación revela evidencia robusta de mediación parcial a través de variables actitudinales, con patrones diferenciados según el nivel educativo. Los resultados muestran que la educación media incompleta o menos experimenta una reducción moderada en su efecto negativo (de -0.637 a -0.419, representando 34% de mediación), mientras que los niveles de educación superior muestran patrones más complejos. La educación técnica superior completa muestra una intensificación paradójica (de 0.271 a 0.578), lo que sugiere supresión estadística donde las variables actitudinales revelan efectos educativos previamente ocultos. Los niveles de educación universitaria presentan los patrones de mediación más claros: universitaria incompleta se intensifica considerablemente (de 0.553 a 1.11, indicando 101% de "mediación negativa"), mientras que universitaria completa cambia sustancialmente (de 0.135 a 0.370), y postgrado también se intensifica (de 0.509 a 1.12).

Los patrones observados sugieren que las variables actitudinales no solo median los efectos educativos sino que también actúan como supresores estadísticos, revelando efectos educativos "puros" una vez controladas las actitudes hacia la justicia social y la estratificación. Esto es particularmente evidente en educación universitaria incompleta, donde el control por variables actitudinales revela un efecto más fuerte, sugiriendo que este grupo tiene actitudes que normalmente reducirían la participación política pero que, una vez controladas, emerge su verdadero potencial contestatario. El patrón general indica que la educación opera a través de múltiples pathways: directamente (a través de recursos cívicos y habilidades) e indirectamente (moldeando actitudes hacia el sistema social), con algunos niveles educativos mostrando efectos suprimidos por sus orientaciones actitudinales características. Estos hallazgos son consistentes con teorías multidimensionales de la participación política que enfatizan tanto recursos como motivaciones actitudinales como mediadores de los efectos educativos.

```{r}
#| warning: false
#| message: false
#| echo: false

library(ggplot2)
library(tidyr)

# Gráfico para educación
comparacion_educacion %>%
  mutate(term = gsub("educ_cat_factor_ref", "", term)) %>%
  pivot_longer(
    cols = c(estimate_total, estimate_directo),
    names_to = "modelo",
    values_to = "estimate"
  ) %>%
  mutate(
    modelo = ifelse(modelo == "estimate_total", 
                    "Efecto Total\n(sin mediadores)", 
                    "Efecto Directo\n(con mediadores)")
  ) %>%
  ggplot(aes(x = term, y = estimate, fill = modelo)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  coord_flip() +
  labs(
    title = "Análisis de Mediación: Efectos de Educación sobre Protesta",
    subtitle = "La reducción indica mediación por variables actitudinales",
    x = "Nivel Educativo",
    y = "Coeficiente (log-odds)",
    fill = "Tipo de Efecto"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Resumen de proporción mediada
comparacion_educacion %>%
  mutate(term = gsub("educ_cat_factor_ref", "", term)) %>%
  ggplot(aes(x = reorder(term, prop_mediada), y = prop_mediada)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() +
  labs(
    title = "Proporción del Efecto Educativo Mediada",
    subtitle = "% del efecto que opera a través de actitudes (justicia, meritocracia, clase, etc.)",
    x = "Nivel Educativo",
    y = "% del Efecto Mediado"
  ) +
  theme_minimal()
```

Los gráficos del análisis de mediación proporcionan evidencia visual clara de cómo las variables actitudinales median los efectos educativos sobre la participación en protestas, revelando patrones complejos de mediación parcial y supresión estadística. El primer gráfico, compara los efectos totales (verde) versus los efectos directos (rojo) para cada nivel educativo y sus interacciones con movilidad, mostrando que la inclusión de variables mediadoras (justicia distributiva, meritocracia, clase subjetiva, satisfacción con ingresos) altera sustancialmente las magnitudes de los coeficientes. Los efectos principales de educación muestran patrones mixtos: algunos se reducen (indicando mediación tradicional), otros se intensifican (sugiriendo supresión estadística), y varios cambian de dirección completamente. Particularmente notable es que los niveles de educación universitaria (incompleta y completa) así como postgrado muestran intensificación de sus efectos al controlar por actitudes, sugiriendo que estos grupos tienen orientaciones actitudinales que normalmente reducirían su participación política, pero una vez controladas, emerge su verdadero potencial contestatario.

El segundo gráfico, cuantifica el porcentaje del efecto educativo que opera a través de las variables actitudinales, revelando una variabilidad extrema en los patrones de mediación. El gráfico muestra que algunos efectos experimentan mediación sustancial (barras largas hacia la derecha), otros muestran "mediación negativa" o supresión (barras hacia la izquierda), y muchos presentan valores cercanos a cero. Los resultados más llamativos incluyen efectos que superan el 100% de mediación (valores > 500%), lo que indica supresión estadística donde las variables actitudinales revelan efectos educativos previamente ocultos. Este patrón es consistente con teorías multidimensionales que sugieren que la educación opera tanto directamente (a través de recursos cívicos) como indirectamente (moldeando actitudes), pero también puede generar orientaciones que contrarrestan su efecto movilizador, requiriendo control estadístico para revelar su verdadero impacto. La evidencia visual confirma que la relación educación-protesta no puede entenderse sin considerar las actitudes políticas como mediadoras y supresoras simultáneas.

```{r}
#| warning: false
#| message: false
#| echo: false

library(gt)

comparacion_educacion %>%
  mutate(
    term = gsub("educ_cat_factor_ref", "", term),
    sig_total = ifelse(p_total < 0.05, "***", ""),
    sig_directo = ifelse(p_directo < 0.05, "***", "")
  ) %>%
  select(
    `Nivel Educativo` = term,
    `Efecto Total` = estimate_total,
    `Sig.` = sig_total,
    `Efecto Directo` = estimate_directo,
    `Sig. ` = sig_directo,
    `Efecto Indirecto` = efecto_indirecto,
    `% Mediado` = prop_mediada
  ) %>%
  gt() %>%
  tab_header(
    title = "Análisis de Mediación: Educación → Protesta",
    subtitle = "Comparación de efectos totales vs. directos"
  ) %>%
  fmt_number(
    columns = c(`Efecto Total`, `Efecto Directo`, `Efecto Indirecto`),
    decimals = 3
  ) %>%
  fmt_number(
    columns = `% Mediado`,
    decimals = 1
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  cols_align(
    align = "left",
    columns = `Nivel Educativo`
  )
```

Esta tabla de análisis de mediación revela patrones fascinantes y complejos que van más allá de la mediación tradicional, mostrando evidencia sustancial de supresión estadística en los efectos educativos. Los efectos principales de educación muestran tres patrones distintos: (1) mediación tradicional en educación media incompleta (-0.637 a -0.419, 34.3% mediado), donde las variables actitudinales explican parte del efecto negativo; (2) supresión estadística en educación técnica y universitaria, donde los efectos se intensifican al controlar por actitudes (técnica completa: 0.271 a 0.578, -113.2% "mediado"; universitaria incompleta: 0.553 a 1.106, -100% "mediado"); y (3) revelación de efectos ocultos en niveles que no eran significativos originalmente pero emergen como significativos tras controlar por mediadores. Esto sugiere que los grupos de educación superior tienen orientaciones actitudinales (mayor percepción de justicia, identificación de clase alta) que normalmente reducirían su participación contestataria, pero una vez controladas estas actitudes conservadoras, emerge su verdadero potencial movilizador basado en recursos cívicos y capacidades políticas.

Los términos de interacción con movilidad muestran variabilidad extrema (desde -733.2% hasta 1,130.7% de "mediación"), reflejando la inestabilidad estadística de estas interacciones que no eran significativas en el modelo original. Los valores extremos como técnica superior completa × movilidad lineal (-733.2%) o media incompleta × movilidad cuadrática (1,130.7%) indican coeficientes muy pequeños en el denominador que generan porcentajes inflados, confirmando que estos efectos son estadísticamente poco confiables. La ausencia de valores (NA) para universitaria completa y postgrado en el componente cúbico refleja problemas de identificación del modelo debido a insuficiente variación muestral. El patrón general confirma que las variables actitudinales no solo median los efectos educativos sino que actúan como supresores estadísticos, revelando que la educación opera de forma contradictoria: mientras proporciona recursos para la movilización, también socializa actitudes que pueden inhibir la participación en protestas, requiriendo descomposición estadística para comprender su efecto neto

# Robutez y Diagnósticos

### Modelos Alternativos

```{r}
#| warning: false
#| message: false
#| echo: false


# A) Variable continua (años de educación)
mod_alt1_continua <- glmmTMB(
  protesta_dummy ~ educ_years * movilidad_years + 
    edad + mujer + ideologia_std + factor(year) +
    (1 | idencuesta),
  data = elsoc_final_2,
  family = binomial(link = "logit"))

screenreg(mod_alt1_continua)

# B) Solo post-estallido (2019+)
mod_alt2_postestallido <- glmmTMB(
  protesta_dummy ~ educ_cat_factor_ref * movilidad_cat_factor +
    edad + mujer + ideologia_std +
    (1 | idencuesta),
  data = elsoc_final_2 %>% filter(year >= 2019),
  family = binomial(link = "logit")
)

screenreg(mod_alt2_postestallido)
```

El Modelo Alternativo 1 utiliza variables continuas (años de educación y años de movilidad) en lugar de categóricas, proporcionando una perspectiva complementaria que confirma los hallazgos principales pero con interpretaciones más directas. Los resultados muestran un efecto principal positivo y robusto de la educación (0.17, p < 0.001), indicando que cada año adicional de educación incrementa las log-odds de participar en protestas en 0.17, equivalente a un aumento del 18.5% en las odds. Este efecto lineal positivo es consistente con el gradiente educativo observado en los modelos categóricos, aunque obviamente no captura las no linealidades específicas entre tipos de educación que revelaron los modelos anteriores. El efecto de movilidad social es negativo (-0.10, p < 0.01), confirmando que cada año adicional de movilidad ascendente reduce la participación en protestas, consistent con teorías de integración social donde el ascenso genera mayor identificación con el sistema establecido.

Crucialmente, el modelo detecta una interacción significativa entre educación y movilidad (0.01, p < 0.05), sugiriendo que el efecto de la educación se intensifica ligeramente con mayor movilidad ascendente. Sin embargo, esta interacción es substantivamente pequeña (0.01) y contrasta con el rechazo de interacciones en los modelos categóricos, posiblemente reflejando diferencias en poder estadístico o en la especificación del modelo. El ajuste del modelo (AIC: 9,946) es comparable al modelo categórico aditivo (AIC: 9,698), indicando capacidad predictiva similar. Las variables de control mantienen los efectos esperados, y los efectos temporales replican el patrón conocido con 2019 como único año positivo. Este modelo alternativo refuerza la robustez de los hallazgos principales sobre efectos positivos de educación y negativos de movilidad, aunque sacrifica la capacidad de detectar patrones no lineales específicos que emergen cuando se distingue entre tipos de educación técnica versus universitaria.

El Modelo Alternativo 2 se enfoca exclusivamente en el período post-estallido social (2019 en adelante), proporcionando una perspectiva crucial sobre si los patrones educativos y de movilidad se mantienen durante el período de mayor activación política en Chile reciente. Los resultados revelan continuidad en los efectos educativos principales pero con algunas modificaciones importantes: educación media incompleta mantiene su efecto negativo (-0.50, p < 0.01), mientras que técnica superior incompleta emerge como el nivel con mayor efecto positivo (0.63, p < 0.01), superando incluso a universitaria incompleta (0.57, p < 0.01). Notably, postgrado pierde significancia estadística (0.91, no significativo), posiblemente reflejando menor variación en este grupo durante el período de crisis o menor poder estadístico debido al tamaño muestral reducido (6,952 vs 12,018 observaciones). El efecto de movilidad se intensifica sustancialmente: el término lineal aumenta de -0.26 (modelo completo) a -0.70 (p < 0.05), sugiriendo que durante períodos de alta movilización social, los efectos de integración por movilidad ascendente se vuelven más pronunciados.

La ausencia generalizada de interacciones significativas en este modelo (todas las interacciones son no significativas) refuerza el rechazo de la hipótesis H2 incluso durante el período de mayor activación política, cuando teóricamente podrían esperarse efectos condicionales más pronunciados. El modelo presenta los mismos problemas de identificación que el modelo completo (eliminación de términos por colinealidad), pero con un AIC proporcionalmente similar considerando el tamaño muestral. El intercepto más alto (1.76 vs 0.54 en modelo completo) refleja los niveles generalmente elevados de participación durante el estallido social. Las variables de control mantienen direcciones esperadas, aunque el efecto de género se reduce y pierde significancia, posiblemente indicando menor brecha de género en participación durante períodos de crisis. Este análisis de robustez temporal confirma que los patrones fundamentales de educación y movilidad no son específicos del período de normalidad política sino que se mantienen durante coyunturas críticas, aunque con algunas intensificaciones en las magnitudes de los efectos.

## Diagnósticos de verificación

```{r}
#| warning: false
#| message: false
#| echo: false
#| results: false


# Para glmmTMB el diagnóstico es diferente
library(glmmTMB)

# Ver si convergió
mod6_h2_interaccion$sdr$pdHess  # Debe ser TRUE

# Mensajes de convergencia
mod6_h2_interaccion$fit$convergence  # Debe ser 0

# Ver warnings completos
summary(mod6_h2_interaccion)
```


```{r}
#| warning: false
#| message: false
#| echo: false

library(car)

# Extraer solo efectos fijos
fixed_formula <- formula(mod6_h2_interaccion, fixed.only = TRUE)

# O manualmente crear modelo lineal temporal
data_vif <- elsoc_final_2 %>% 
  filter(!is.na(movilidad_cat_factor))

# Modelo lineal simple para VIF (solo efectos fijos)
mod_temp <- lm(
  protesta_dummy ~ educ_cat_factor_ref + movilidad_cat_factor +
    edad + edad_cuadratica + mujer + ideologia_std + interes_politica + 
    factor(year),
  data = data_vif
)

# Calcular VIF
vif_vals <- vif(mod_temp)
print(vif_vals)
```

```{r}
#| warning: false
#| message: false
#| echo: false

library(DHARMa)  # Mejor paquete para modelos mixtos

# Crear residuos simulados
sim_residuals <- simulateResiduals(
  fittedModel = mod6_h2_interaccion, 
  n = 1000,  # Número de simulaciones
  plot = FALSE
)

# Diagnósticos visuales completos
plot(sim_residuals)

# Tests específicos
testUniformity(sim_residuals)  # Test de uniformidad
testDispersion(sim_residuals)   # Test de sobredispersión
testOutliers(sim_residuals)     # Test de outliers
testZeroInflation(sim_residuals) # Test de zero-inflation

# Gráficos individuales
plotQQunif(sim_residuals)       # QQ plot
plotResiduals(sim_residuals)    # Residuos vs predichos
```

Los gráficos de diagnóstico proporcionan una evaluación comprehensiva de la calidad del ajuste del modelo de regresión logística multinivel, revelando un buen ajuste que valida la especificación del modelo final. El QQ plot de residuos (primer gráfico) muestra una alineación casi perfecta entre los residuos observados y los esperados bajo el modelo teórico, con todos los puntos siguiendo estrechamente la línea diagonal roja. El test de Kolmogorov-Smirnov confirma que no hay desviación significativa de la distribución esperada (p = 0.654), mientras que el test de outliers también es no significativo (p = 0.183), indicando ausencia de valores atípicos problemáticos. El gráfico de residuos versus predichos (panel superior derecho) muestra una distribución homogénea sin patrones sistemáticos, y crucialmente, el test de dispersión no detecta sobredispersión (p = 0.346), confirmando que el modelo binomial es apropiado para estos datos.

Los tests de uniformidad y sobredispersión (histogramas) proporcionan evidencia adicional de la calidad del modelo a través de simulaciones Monte Carlo. El histograma de dispersión muestra que el valor observado del modelo (línea roja vertical) cae bien dentro de la distribución de valores simulados bajo la hipótesis nula de ajuste correcto, con un p-valor bilateral de 0.346 que confirma ausencia de sobredispersión. El test de zero-inflation indica que el modelo no sufre de exceso de ceros (p = 0.206), validando que la estructura binomial simple es suficiente sin necesidad de modelos de inflación de ceros. La distribución uniforme de residuos confirma que el modelo captura adecuadamente la variabilidad en los datos sin patrones residuales sistemáticos. En conjunto, estos diagnósticos validan que el modelo final (Modelo 5 Aditivo) cumple con todos los supuestos estadísticos necesarios para modelos logísticos multinivel, proporcionando confianza en la validez de las inferencias sobre los efectos de educación y movilidad social en la participación en protestas.

## Tablas de Resultados

```{r}
#| warning: false
#| message: false
#| echo: false

library(modelsummary)

# Crear tabla comparativa
modelsummary(
  list(
    "Pooled" = mod_pooled,
    "RE Simple" = mod1_educ_simple,
    "RE Demo" = mod2_educ_demo,
    "RE Full (H1)" = mod3_h1_full,
    "RE Aditivo" = mod5_aditivo,
    "RE Interacción (H2)" = mod6_h2_interaccion
  ),
  output = "gt",
  stars = c('*' = .05, '**' = .01, '***' = .001),
  coef_rename = c(
    "(Intercept)" = "Intercepto",
    "edad" = "Edad",
    "mujer" = "Mujer",
    "ideologia_std" = "Ideología (izq-der)"
  ),
  gof_map = c("nobs", "aic", "bic"),
  notes = "Fuente: Elaboración propia con datos ELSOC (2016-2023). Errores estándar robustos por cluster en paréntesis."
)

```


```{r}
#| warning: false
#| message: false
#| echo: false

# Coeficientes de educación
educ_coefs <- tibble(
  Nivel = rep(c("Media incomp-", "Téc sup incomp", "Téc sup comp", 
                "Univ incomp", "Univ comp", "Postgrado"), 6),
  Modelo = rep(c("Pooled", "RE Simple", "RE Demo", "RE Full", "RE Aditivo", "RE Interacción"), each = 6),
  Coef = c(
    # Pooled
    -0.036, 0.042, 0.038, 0.107, 0.076, 0.160,
    # RE Simple
    -0.869, 0.834, 0.498, 1.432, 1.069, 1.630,
    # RE Demo
    -0.534, 0.547, 0.441, 0.984, 0.890, 1.544,
    # RE Full
    -0.598, 0.397, 0.328, 0.686, 0.586, 0.986,
    # RE Aditivo
    -0.610, 0.406, 0.320, 0.627, 0.609, 0.994,
    # RE Interacción
    -0.637, 0.319, 0.271, 0.553, 0.135, 0.509
  ),
  Sig = c(
    # Pooled
    "***", "*", "***", "***", "***", "***",
    # RE Simple
    "***", "***", "***", "***", "***", "***",
    # RE Demo
    "***", "***", "***", "***", "***", "***",
    # RE Full
    "***", "*", "**", "***", "***", "***",
    # RE Aditivo
    "***", "**", "**", "***", "***", "***",
    # RE Interacción
    "***", "", "", "***", "", ""
  )
)

# Gráfico de evolución de coeficientes
ggplot(educ_coefs, aes(x = Modelo, y = Coef, 
                        group = Nivel, color = Nivel)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "Evolución de Coeficientes Educativos por Modelo",
    subtitle = "Los coeficientes se reducen al agregar controles",
    y = "Coeficiente (log-odds)",
    x = NULL,
    color = "Nivel Educativo"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

El gráfico "Evolución de Coeficientes Educativos por Modelo" ilustra de manera clara cómo los efectos educativos se transforman progresivamente a medida que se agregan controles estadísticos, revelando la robustez y estabilidad de los patrones fundamentales. La línea amarilla (Postgrado) muestra la trayectoria más dramática: comienza con el coeficiente más alto en el modelo pooled (aproximadamente 0.16), se eleva sustancialmente en los modelos de efectos aleatorios simples y demográficos (alcanzando su pico de 1.6), y luego se estabiliza en valores moderados (alrededor de 1.0) una vez incorporadas las variables actitudinales y de movilidad. Esta evolución sugiere que el efecto del postgrado es robusto pero se ve inflado cuando no se controlan adecuadamente las características individuales y actitudinales que correlacionan tanto con el nivel educativo como con la participación política.

Las líneas de educación universitaria (completa e incompleta, en azul y magenta respectivamente) muestran patrones similares pero con magnitudes diferentes, manteniéndose consistentemente por encima de la línea de referencia (cero) a través de todos los modelos, lo que confirma su efecto positivo robusto sobre la participación en protestas. Particularmente notable es la estabilidad relativa de estos efectos una vez controladas las variables demográficas, sugiriendo que los efectos universitarios no son meramente artefactos de diferencias de edad o género. Por el contrario, la línea roja (Media incompleta o menos) permanece consistentemente en territorio negativo a través de todos los modelos, confirmando que este grupo tiene menor probabilidad de participar en protestas independientemente de los controles incluidos. Los niveles de educación técnica (líneas verde y turquesa) muestran trayectorias más modestas pero positivas, validando la hipótesis de que la educación post-secundaria, independientemente del tipo, incrementa la participación política. El patrón general del gráfico confirma que los efectos educativos no son espurios sino que reflejan diferencias genuinas en participación política que trascienden características demográficas y actitudinales.

```{r}
#| warning: false
#| message: false
#| echo: false

library(gt)

# Tabla comparativa de modelos clave
tabla_final <- tibble(
  Variable = c(
    "Educación", "  Media incompleta o menos", "  Universitaria incompleta", 
    "  Universitaria completa", "  Postgrado",
    "Movilidad (lineal)", "Edad", "Mujer", 
    "Ideología (izq-der)", "Interés político",
    "", "N observaciones", "AIC", "BIC", "SD efectos aleatorios"
  ),
  `RE Simple` = c(
    "", "-0.869***", "1.432***", "1.069***", "1.630***",
    "", "", "", "", "",
    "", "20,052", "16,111.9", "16,175.2", "1.430"
  ),
  `RE Full (H1)` = c(
    "", "-0.598***", "0.686***", "0.586***", "0.986***",
    "", "-0.044***", "-0.205**", "-0.214***", "0.456***",
    "", "12,648", "10,009.6", "10,158.5", "1.370"
  ),
  `RE Aditivo` = c(
    "", "-0.610***", "0.627***", "0.609***", "0.994***",
    "-0.260*", "-0.043***", "-0.222**", "-0.217***", "0.426***",
    "", "12,018", "9,697.8", "9,853.0", "1.360"
  ),
  `RE Interacción (H2)` = c(
    "", "-0.637***", "0.553***", "0.135", "0.509",
    "-0.313", "-0.043***", "-0.222**", "-0.218***", "0.427***",
    "", "12,018", "9,712.4", "9,986.0", "1.353"
  )
)

tabla_final %>%
  gt() %>%
  tab_header(
    title = "Modelos de Regresión Logística Multinivel",
    subtitle = "Variable dependiente: Participación en protestas (dummy)"
  ) %>%
  tab_footnote(
    footnote = "* p < 0.05, ** p < 0.01, *** p < 0.001"
  ) %>%
  tab_source_note(
    source_note = "Fuente: Elaboración propia con datos ELSOC (2016-2023)"
  ) %>%
  cols_align(
    align = "left",
    columns = Variable
  ) %>%
  cols_align(
    align = "center",
    columns = 2:5
  )
```

# Conclusiones principales modelos exploratorios:

- Modelo óptimo: RE Aditivo (menor AIC)
- Hipótesis H2 rechazada: La interacción NO mejora el modelo
- Efectos robustos: Educación, ideología e interés político son predictores consistentes
- Movilidad social: Efecto lineal negativo en modelo aditivo
- Mediación: Variables actitudinales median ~40-50% del efecto educativo

Para evaluar la hipótesis H1 sobre el efecto de la educación, se estimó una serie de modelos logísticos multinivel. El Modelo 2 (RE Full) muestra que, controlando variables demográficas, actitudinales y temporales, la educación mantiene un efecto positivo robusto sobre la participación en protestas. El gradiente educativo es claro: desde un efecto negativo en educación media incompleta o menos (β = -0.598, p < 0.001) hasta un efecto positivo máximo en postgrado (β = 0.986, p < 0.001), pasando por niveles intermedios significativos en educación universitaria.
La inclusión de ideología política e interés político (Modelo 3) reduce los coeficientes educativos aproximadamente 40-50% respecto al modelo demográfico básico (Modelo 2), sugiriendo mediación parcial por variables actitudinales. Sin embargo, los efectos educativos se mantienen significativos, indicando que la educación opera tanto directamente como a través de actitudes políticas.

Para evaluar la hipótesis H2 sobre movilidad social, se estimaron dos modelos adicionales: uno con efectos aditivos de educación y movilidad (Modelo 4) y otro con interacciones entre ambas (Modelo 5). El Modelo 4 muestra un efecto lineal negativo de la movilidad social (β = -0.260, p < 0.05), consistente con la hipótesis de integración: mayor movilidad ascendente se asocia con menor participación en protestas, controlando nivel educativo alcanzado.
El modelo con interacciones (Modelo 5) no mejora el ajuste respecto al modelo aditivo (ΔAIC = +14.6; ΔBIC = +133.0), y solo una de las 18 interacciones resulta significativa. Por tanto, se rechaza la hipótesis H2 de que el efecto de la educación varía según la trayectoria de movilidad social. Los datos apoyan un modelo donde educación y movilidad tienen efectos independientes y aditivos sobre la protesta.

La tabla comparativa de modelos revela una progresión sistemática desde especificaciones básicas hasta el modelo óptimo, confirmando la robustez de los hallazgos educativos. La evolución desde el modelo RE Simple (AIC: 16,112) hasta el RE Aditivo (AIC: 9,698) demuestra mejoras sustanciales en ajuste estadístico mediante la incorporación progresiva de controles demográficos, actitudinales y de movilidad. Crucialmente, los efectos educativos se mantienen significativos y en la misma dirección a través de todas las especificaciones, aunque con magnitudes reducidas: el efecto de universitaria incompleta decrece de 1.432 en el modelo simple a 0.627 en el modelo aditivo, mientras que postgrado se reduce de 1.630 a 0.994. Esta atenuación controlada indica que los efectos educativos no son espurios sino que reflejan mediación parcial por variables demográficas y actitudinales, manteniendo efectos directos sustanciales sobre la participación contestataria.

El Modelo RE Aditivo emerge como especificación óptima por múltiples criterios convergentes: menor AIC (9,698), balance favorable entre AIC y BIC (9,853), y significancia estadística de todos los predictores principales. La introducción de movilidad social (-0.260, p < 0.05) mejora el poder explicativo sin comprometer la estabilidad de los efectos educativos, confirmando que ambos constructos aportan información independiente para predecir participación política. El modelo RE Interacción (H2), pese a incluir 16 términos adicionales, no mejora el ajuste (ΔAIC = +14.6) y genera pérdida de significancia en varios niveles educativos (universitaria completa y postgrado), evidenciando sobreajuste estadístico que justifica su rechazo.

El rechazo definitivo de la hipótesis H2 tiene profundas implicaciones teóricas. Los datos chilenos no apoyan teorías de frustración relativa que predicen efectos educativos condicionales según trayectorias de movilidad, sino que favorecen modelos aditivos donde educación y movilidad operan a través de mecanismos causales independientes. Esto es consistente con teorías de recursos cívicos (Brady et al., 1995) que enfatizan la educación como proveedora universal de habilidades políticas, independiente de la trayectoria social experimentada. Simultáneamente, el efecto negativo robusto de la movilidad ascendente (-0.260) apoya teorías de integración social: quienes experimentan ascenso desarrollan mayor identificación sistémica, reduciendo incentivos contestatarios independientemente de su nivel educativo final. Esta separación analítica entre efectos educativos (recursos) y efectos de movilidad (integración) proporciona evidencia empírica para modelos teóricos que distinguen entre mecanismos cognitivos/instrumentales versus mecanismos identitarios/normativos en la participación política.

```{r}
#| warning: false
#| message: false
#| echo: false


# Gráfico 2: Probabilidades predichas H2
plot_model(mod6_h2_interaccion,
           type = "pred",
           terms = c("educ_cat_factor_ref", "movilidad_cat_factor"),
           title = "Interacción: Educación × Movilidad")

# Gráfico 3: Efectos marginales
plot_model(mod6_h2_interaccion,
           type = "int",
           title = "Efecto marginal de educación según movilidad")
```

Los gráficos de probabilidades predichas y efectos marginales proporcionan una visualización complementaria que confirma visualmente el rechazo de la hipótesis H2 sobre interacciones entre educación y movilidad social. El primer gráfico ("Interacción: Educación × Movilidad") muestra las probabilidades predichas para cada combinación de nivel educativo y tipo de movilidad, revelando patrones que carecen de coherencia teórica sistemática. Los intervalos de confianza son amplios y se superponen considerablemente entre diferentes tipos de movilidad dentro de cada nivel educativo, particularmente en los niveles de educación superior donde las diferencias entre trayectorias de movilidad son mínimas y estadísticamente no significativas. La ausencia de patrones divergentes claros entre las líneas de movilidad a medida que aumenta el nivel educativo confirma que no existe una interacción sustantiva entre estos predictores.

El segundo gráfico ("Efecto marginal de educación según movilidad") es prácticamente idéntico al primero, lo que refuerza la conclusión de que los efectos educativos son constantes across diferentes trayectorias de movilidad social. La superposición visual de los intervalos de confianza y la ausencia de pendientes divergentes entre tipos de movilidad validan estadísticamente el modelo aditivo como especificación correcta. Estos gráficos, generados desde el modelo de interacción saturado, demuestran que incluso cuando se permite máxima flexibilidad estadística, los datos no revelan patrones condicionales teóricamente interpretables. La evidencia visual converge con los tests estadísticos formales (LRT p = 0.365) para rechazar definitivamente H2, apoyando la conclusión de que educación y movilidad operan como predictores independientes de participación política contestataria, consistent con teorías que distinguen entre mecanismos de recursos cívicos versus integración social en la movilización política.